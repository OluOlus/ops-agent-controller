AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'OpsAgent Controller - Serverless conversational Tier-1 Ops assistant'

Parameters:
  Environment:
    Type: String
    Default: sandbox
    AllowedValues:
      - sandbox
      - staging
      - production
    Description: Deployment environment
  
  ExecutionMode:
    Type: String
    Default: SANDBOX_LIVE
    AllowedValues:
      - LOCAL_MOCK
      - DRY_RUN
      - SANDBOX_LIVE
    Description: OpsAgent execution mode (Requirement 10 - LOCAL_MOCK, DRY_RUN, SANDBOX_LIVE)
  
  LLMProvider:
    Type: String
    Default: bedrock
    AllowedValues:
      - bedrock
      - openai
      - azure_openai
    Description: LLM provider to use
  
  BedrockModelId:
    Type: String
    Default: anthropic.claude-3-sonnet-20240229-v1:0
    Description: Bedrock model ID for LLM provider
  
  ApiKeyParameterName:
    Type: String
    Default: /opsagent/api-key
    Description: SSM Parameter name for API key (optional)
  
  EnableDynamoDBEncryption:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Enable DynamoDB encryption at rest
  
  CreateTestResources:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Create test EC2 instance for remediation testing
  
  LatestAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
    Description: Latest Amazon Linux 2 AMI ID

  AwsAccountId:
    Type: String
    Default: ''
    Description: AWS Account ID for cross-account operations (optional, defaults to current account)

  AmazonQAppId:
    Type: String
    Default: ''
    Description: Amazon Q Business Application ID for hybrid LLM integration (optional)

  AmazonQUserId:
    Type: String
    Default: 'opsagent-user'
    Description: Amazon Q Business User ID for sessions (optional)

  AmazonQSessionId:
    Type: String
    Default: ''
    Description: Amazon Q Business Session ID for conversation continuity (optional)

Conditions:
  EnableEncryption: !Equals [!Ref EnableDynamoDBEncryption, 'true']
  CreateTestResources: !Equals [!Ref CreateTestResources, 'true']
  HasCustomAwsAccountId: !Not [!Equals [!Ref AwsAccountId, '']]
  HasAmazonQIntegration: !Not [!Equals [!Ref AmazonQAppId, '']]

Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Runtime: python3.11
    Environment:
      Variables:
        EXECUTION_MODE: !Ref ExecutionMode
        ENVIRONMENT: !Ref Environment
        LLM_PROVIDER: !Ref LLMProvider
        BEDROCK_MODEL_ID: !Ref BedrockModelId
    Tags:
      Project: OpsAgent
      Environment: !Ref Environment
      Owner: Platform-Team

Resources:
  # KMS Key for encryption
  OpsAgentKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: 'KMS Key for OpsAgent Controller encryption'
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: Allow CloudWatch Logs
            Effect: Allow
            Principal:
              Service: !Sub 'logs.${AWS::Region}.amazonaws.com'
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: '*'
          - Sid: Allow Lambda Function
            Effect: Allow
            Principal:
              AWS: !GetAtt OpsAgentExecutionRole.Arn
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: '*'
      Tags:
        - Key: Project
          Value: OpsAgent
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: Platform-Team
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain

  OpsAgentKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub 'alias/opsagent-${Environment}'
      TargetKeyId: !Ref OpsAgentKMSKey

  # API Gateway with OpenAPI Schema
  OpsAgentApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Environment
      DefinitionUri: openapi-schema.yaml
      Variables:
        LambdaFunctionName: !Ref OpsAgentFunction
      EndpointConfiguration:
        Type: REGIONAL
      TracingEnabled: true
      MethodSettings:
        - ResourcePath: '/*'
          HttpMethod: '*'
          LoggingLevel: INFO
          DataTraceEnabled: true
          MetricsEnabled: true
          ThrottlingRateLimit: 100
          ThrottlingBurstLimit: 200
      AccessLogSetting:
        DestinationArn: !GetAtt ApiGatewayLogGroup.Arn
        Format: '{"requestId":"$context.requestId","ip":"$context.identity.sourceIp","caller":"$context.identity.caller","user":"$context.identity.user","requestTime":"$context.requestTime","httpMethod":"$context.httpMethod","resourcePath":"$context.resourcePath","status":"$context.status","protocol":"$context.protocol","responseLength":"$context.responseLength"}'
      Tags:
        Project: OpsAgent
        Environment: !Ref Environment
        Owner: Platform-Team

  # CloudWatch Log Group for API Gateway
  ApiGatewayLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/apigateway/opsagent-${Environment}'
      RetentionInDays: 30
      KmsKeyId: !GetAtt OpsAgentKMSKey.Arn
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  # Lambda Function
  OpsAgentFunction:
    Type: AWS::Serverless::Function
    DependsOn:
      - OpsAgentAuditLoggingPolicy
      - OpsAgentDiagnosisToolsPolicy
      - OpsAgentRemediationToolsPolicy
      - OpsAgentLLMProviderPolicy
      - OpsAgentSystemPolicy
    Properties:
      FunctionName: !Sub 'opsagent-controller-${Environment}'
      CodeUri: ../src/
      Handler: main.lambda_handler
      Description: 'OpsAgent Controller - Main Lambda function'
      Role: !GetAtt OpsAgentExecutionRole.Arn
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt DeadLetterQueue.Arn
      Events:
        HealthCheck:
          Type: Api
          Properties:
            RestApiId: !Ref OpsAgentApi
            Path: /health
            Method: GET
            Auth:
              ApiKeyRequired: false
        DiagnosticOperations:
          Type: Api
          Properties:
            RestApiId: !Ref OpsAgentApi
            Path: /operations/diagnostic
            Method: POST
            Auth:
              ApiKeyRequired: true
        ProposeAction:
          Type: Api
          Properties:
            RestApiId: !Ref OpsAgentApi
            Path: /operations/propose
            Method: POST
            Auth:
              ApiKeyRequired: true
        ApproveAction:
          Type: Api
          Properties:
            RestApiId: !Ref OpsAgentApi
            Path: /operations/approve
            Method: POST
            Auth:
              ApiKeyRequired: true
        WorkflowOperations:
          Type: Api
          Properties:
            RestApiId: !Ref OpsAgentApi
            Path: /operations/workflow
            Method: POST
            Auth:
              ApiKeyRequired: true
        # Legacy chat endpoint for backward compatibility
        ChatMessage:
          Type: Api
          Properties:
            RestApiId: !Ref OpsAgentApi
            Path: /chat
            Method: POST
            Auth:
              ApiKeyRequired: true
      Environment:
        Variables:
          EXECUTION_MODE: !Ref ExecutionMode
          ENVIRONMENT: !Ref Environment
          LLM_PROVIDER: !Ref LLMProvider
          BEDROCK_MODEL_ID: !Ref BedrockModelId
          AUDIT_LOG_GROUP: !Ref AuditLogGroup
          CLOUDWATCH_LOG_GROUP: !Ref AuditLogGroup
          AUDIT_TABLE_NAME: !Ref AuditTable
          INCIDENT_TABLE_NAME: !Ref IncidentTable
          NOTIFICATION_TOPIC_ARN: !Ref NotificationTopic
          KMS_KEY_ID: !Ref OpsAgentKMSKey
          API_KEY_PARAMETER: !Ref ApiKeyParameterName
          PLUGIN_API_KEY_PARAMETER: !Ref OpsAgentApiKeyParameter
          AWS_ACCOUNT_ID: !If
            - HasCustomAwsAccountId
            - !Ref AwsAccountId
            - !Ref AWS::AccountId
          AMAZON_Q_APP_ID: !If
            - HasAmazonQIntegration
            - !Ref AmazonQAppId
            - !Ref AWS::NoValue
          AMAZON_Q_USER_ID: !If
            - HasAmazonQIntegration
            - !Ref AmazonQUserId
            - !Ref AWS::NoValue
          AMAZON_Q_SESSION_ID: !If
            - HasAmazonQIntegration
            - !Ref AmazonQSessionId
            - !Ref AWS::NoValue
      Tags:
        Project: OpsAgent
        Environment: !Ref Environment
        Owner: Platform-Team

  # Dead Letter Queue for failed Lambda invocations
  DeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub 'opsagent-dlq-${Environment}'
      MessageRetentionPeriod: 1209600  # 14 days
      KmsMasterKeyId: !Ref OpsAgentKMSKey
      Tags:
        - Key: Project
          Value: OpsAgent
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: Platform-Team
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  # IAM Role for Lambda execution with least privilege permissions
  OpsAgentExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Tags:
        - Key: Project
          Value: OpsAgent
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: Platform-Team

  # Separate IAM policies for better organization and least privilege
  OpsAgentAuditLoggingPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: OpsAgentAuditLoggingPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # CloudWatch Logs permissions for audit logging
          - Effect: Allow
            Action:
              - logs:CreateLogStream
              - logs:PutLogEvents
              - logs:DescribeLogGroups
              - logs:DescribeLogStreams
            Resource: 
              - !GetAtt AuditLogGroup.Arn
              - !GetAtt ApiGatewayLogGroup.Arn
          
          # DynamoDB permissions for audit storage and incident records
          - Effect: Allow
            Action:
              - dynamodb:PutItem
              - dynamodb:GetItem
              - dynamodb:Query
              - dynamodb:UpdateItem
            Resource: 
              - !GetAtt AuditTable.Arn
              - !GetAtt IncidentTable.Arn
              - !Sub '${IncidentTable.Arn}/index/*'
          
          # SNS permissions for notifications
          - Effect: Allow
            Action:
              - sns:Publish
            Resource: !Ref NotificationTopic
          
          # KMS permissions for encryption
          - Effect: Allow
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: !GetAtt OpsAgentKMSKey.Arn
          
          # SQS permissions for dead letter queue
          - Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt DeadLetterQueue.Arn
      Roles:
        - !Ref OpsAgentExecutionRole

  OpsAgentDiagnosisToolsPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: OpsAgentDiagnosisToolsPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # CloudWatch read-only permissions for diagnosis tools
          - Effect: Allow
            Action:
              - cloudwatch:GetMetricStatistics
              - cloudwatch:GetMetricData
              - cloudwatch:ListMetrics
              - cloudwatch:DescribeAlarms
              - cloudwatch:GetMetricWidgetImage
            Resource: '*'
          
          # EC2 read-only permissions for diagnosis tools
          - Effect: Allow
            Action:
              - ec2:DescribeInstances
              - ec2:DescribeInstanceStatus
              - ec2:DescribeTags
              - ec2:DescribeImages
              - ec2:DescribeSecurityGroups
              - ec2:DescribeVpcs
              - ec2:DescribeSubnets
            Resource: '*'
          
          # ECS/ALB read-only permissions for diagnosis tools
          - Effect: Allow
            Action:
              - ecs:DescribeServices
              - ecs:DescribeTasks
              - ecs:DescribeClusters
              - ecs:DescribeTaskDefinition
              - ecs:ListTasks
              - ecs:ListServices
              - elasticloadbalancing:DescribeLoadBalancers
              - elasticloadbalancing:DescribeTargetGroups
              - elasticloadbalancing:DescribeTargetHealth
              - elasticloadbalancing:DescribeListeners
              - elasticloadbalancing:DescribeRules
            Resource: '*'
          
          # Additional AWS services for comprehensive diagnosis
          - Effect: Allow
            Action:
              - application-autoscaling:DescribeScalingPolicies
              - autoscaling:DescribeAutoScalingGroups
              - autoscaling:DescribeScalingActivities
              - logs:DescribeLogGroups
              - logs:DescribeLogStreams
              - logs:FilterLogEvents
              - cloudtrail:LookupEvents
              - cloudtrail:DescribeTrails
            Resource: '*'
      Roles:
        - !Ref OpsAgentExecutionRole

  OpsAgentRemediationToolsPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: OpsAgentRemediationToolsPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # EC2 remediation permissions (restricted to tagged resources)
          - Effect: Allow
            Action:
              - ec2:RebootInstances
              - ec2:StartInstances
              - ec2:StopInstances
            Resource: '*'
            Condition:
              StringEquals:
                'ec2:ResourceTag/OpsAgentManaged': 'true'
          
          # Additional remediation actions (also restricted to tagged resources)
          - Effect: Allow
            Action:
              - ecs:UpdateService
              - ecs:RestartTask
            Resource: '*'
            Condition:
              StringEquals:
                'aws:ResourceTag/OpsAgentManaged': 'true'
          
          # Auto Scaling remediation (restricted to tagged resources)
          - Effect: Allow
            Action:
              - autoscaling:SetDesiredCapacity
              - autoscaling:UpdateAutoScalingGroup
            Resource: '*'
            Condition:
              StringEquals:
                'aws:ResourceTag/OpsAgentManaged': 'true'
      Roles:
        - !Ref OpsAgentExecutionRole

  OpsAgentLLMProviderPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: OpsAgentLLMProviderPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # Bedrock permissions for LLM provider
          - Effect: Allow
            Action:
              - bedrock:InvokeModel
              - bedrock:InvokeModelWithResponseStream
            Resource: 
              - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0'
              - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/anthropic.claude-3-haiku-20240307-v1:0'
              - !Sub 'arn:aws:bedrock:${AWS::Region}::foundation-model/anthropic.claude-instant-v1'
          
          # Amazon Q Business permissions for hybrid LLM integration
          - Effect: Allow
            Action:
              - qbusiness:ChatSync
              - qbusiness:Chat
              - qbusiness:GetApplication
              - qbusiness:ListConversations
            Resource: 
              - !If
                - HasAmazonQIntegration
                - !Sub 'arn:aws:qbusiness:${AWS::Region}:${AWS::AccountId}:application/${AmazonQAppId}'
                - !Ref AWS::NoValue
              - !If
                - HasAmazonQIntegration
                - !Sub 'arn:aws:qbusiness:${AWS::Region}:${AWS::AccountId}:application/${AmazonQAppId}/*'
                - !Ref AWS::NoValue
          
          # SSM Parameter Store permissions for API keys and configuration
          - Effect: Allow
            Action:
              - ssm:GetParameter
              - ssm:GetParameters
              - ssm:GetParametersByPath
            Resource: 
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/opsagent/*'
          
          # Secrets Manager permissions for sensitive configuration
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource: 
              - !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:opsagent/*'
      Roles:
        - !Ref OpsAgentExecutionRole

  OpsAgentSystemPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: OpsAgentSystemPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # STS permissions for identity validation
          - Effect: Allow
            Action:
              - sts:GetCallerIdentity
            Resource: '*'
          
          # X-Ray permissions for tracing
          - Effect: Allow
            Action:
              - xray:PutTraceSegments
              - xray:PutTelemetryRecords
            Resource: '*'
      Roles:
        - !Ref OpsAgentExecutionRole

  # CloudWatch Log Group for audit logging
  AuditLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/opsagent-audit-${Environment}'
      RetentionInDays: 90
      KmsKeyId: !GetAtt OpsAgentKMSKey.Arn
      Tags:
        - Key: Project
          Value: OpsAgent
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: Platform-Team
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain

  # DynamoDB table for incident records
  IncidentTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'opsagent-incidents-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: incidentId
          AttributeType: S
        - AttributeName: severity
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: incidentId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: SeverityCreatedIndex
          KeySchema:
            - AttributeName: severity
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: UserIdCreatedIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      SSESpecification:
        SSEEnabled: !If [EnableEncryption, true, false]
        SSEType: !If [EnableEncryption, KMS, !Ref 'AWS::NoValue']
        KMSMasterKeyId: !If [EnableEncryption, !Ref OpsAgentKMSKey, !Ref 'AWS::NoValue']
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Project
          Value: OpsAgent
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: Platform-Team
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain

  # SNS Topic for notifications
  NotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub 'opsagent-notifications-${Environment}'
      DisplayName: 'OpsAgent Notifications'
      KmsMasterKeyId: !Ref OpsAgentKMSKey
      Tags:
        - Key: Project
          Value: OpsAgent
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: Platform-Team

  # DynamoDB table for audit storage with encryption
  AuditTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'opsagent-audit-${Environment}'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: correlationId
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: correlationId
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: UserIdIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      SSESpecification:
        SSEEnabled: !If [EnableEncryption, true, false]
        SSEType: !If [EnableEncryption, KMS, !Ref 'AWS::NoValue']
        KMSMasterKeyId: !If [EnableEncryption, !Ref OpsAgentKMSKey, !Ref 'AWS::NoValue']
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Project
          Value: OpsAgent
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: Platform-Team
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain

  # API Key for Amazon Q Business Plugin
  OpsAgentApiKey:
    Type: AWS::ApiGateway::ApiKey
    Properties:
      Name: !Sub 'opsagent-plugin-key-${Environment}'
      Description: 'API Key for Amazon Q Business OpsAgent Plugin'
      Enabled: true
      Tags:
        - Key: Project
          Value: OpsAgent
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: Platform-Team

  # Usage Plan for API Key
  OpsAgentUsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    Properties:
      UsagePlanName: !Sub 'opsagent-usage-plan-${Environment}'
      Description: 'Usage plan for OpsAgent Plugin API'
      ApiStages:
        - ApiId: !Ref OpsAgentApi
          Stage: !Ref Environment
      Throttle:
        RateLimit: 100
        BurstLimit: 200
      Quota:
        Limit: 10000
        Period: DAY
      Tags:
        - Key: Project
          Value: OpsAgent
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: Platform-Team

  # Link API Key to Usage Plan
  OpsAgentUsagePlanKey:
    Type: AWS::ApiGateway::UsagePlanKey
    Properties:
      KeyId: !Ref OpsAgentApiKey
      KeyType: API_KEY
      UsagePlanId: !Ref OpsAgentUsagePlan

  # Store API Key in SSM Parameter Store
  OpsAgentApiKeyParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub '/opsagent/plugin-api-key-${Environment}'
      Type: SecureString
      Value: !Ref OpsAgentApiKey
      Description: 'API Key for Amazon Q Business OpsAgent Plugin'
      Tags:
        Project: OpsAgent
        Environment: !Ref Environment
        Owner: Platform-Team

  # SSM Parameter for API Key (optional)
  ApiKeyParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Ref ApiKeyParameterName
      Type: String
      Value: !Sub 'changeme-${AWS::AccountId}-${Environment}'
      Description: 'API key for OpsAgent Controller authentication'
      Tags:
        Project: OpsAgent
        Environment: !Ref Environment
        Owner: Platform-Team

  # SSM Parameter for Teams Bot Secret (required for Teams integration)
  # TeamsBotSecretParameter:
  #   Type: AWS::SSM::Parameter
  #   Properties:
  #     Name: '/opsagent/teams-bot-app-secret'
  #     Type: String
  #     Value: 'CHANGE_ME_TO_YOUR_BOT_SECRET'
  #     Description: 'Microsoft Teams Bot Framework client secret'
  #     Tags:
  #       Project: OpsAgent
  #       Environment: !Ref Environment
  #       Owner: Platform-Team

  # Test EC2 Instance for remediation testing (tagged for OpsAgent management)
  TestInstance:
    Type: AWS::EC2::Instance
    Condition: CreateTestResources
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: t3.micro
      IamInstanceProfile: !Ref TestInstanceProfile
      SecurityGroupIds:
        - !Ref TestSecurityGroup
      SubnetId: subnet-023cf72072982239e
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y amazon-cloudwatch-agent
          # Configure CloudWatch agent for metrics
          cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json << 'EOF'
          {
            "metrics": {
              "namespace": "OpsAgent/Test",
              "metrics_collected": {
                "cpu": {
                  "measurement": ["cpu_usage_idle", "cpu_usage_iowait", "cpu_usage_user", "cpu_usage_system"],
                  "metrics_collection_interval": 60
                },
                "disk": {
                  "measurement": ["used_percent"],
                  "metrics_collection_interval": 60,
                  "resources": ["*"]
                },
                "mem": {
                  "measurement": ["mem_used_percent"],
                  "metrics_collection_interval": 60
                }
              }
            }
          }
          EOF
          /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s
      Tags:
        - Key: Name
          Value: !Sub 'opsagent-test-instance-${Environment}'
        - Key: Project
          Value: OpsAgent
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: Platform-Team
        - Key: OpsAgentManaged
          Value: 'true'

  # Security Group for test instance
  TestSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: CreateTestResources
    Properties:
      GroupDescription: Security group for OpsAgent test instance
      VpcId: vpc-084537f64f2a1ea5d
      Tags:
        - Key: Name
          Value: !Sub 'opsagent-test-sg-${Environment}'
        - Key: Project
          Value: OpsAgent
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: Platform-Team

  # IAM Role for test instance
  TestInstanceRole:
    Type: AWS::IAM::Role
    Condition: CreateTestResources
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
      Tags:
        - Key: Project
          Value: OpsAgent
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: Platform-Team

  TestInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Condition: CreateTestResources
    Properties:
      Roles:
        - !Ref TestInstanceRole

Outputs:
  PluginApiEndpointUrl:
    Description: 'Plugin API endpoint URL for Amazon Q Business'
    Value: !Sub 'https://${OpsAgentApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}'
    Export:
      Name: !Sub '${AWS::StackName}-PluginApiUrl'

  DiagnosticEndpointUrl:
    Description: 'Diagnostic operations endpoint'
    Value: !Sub 'https://${OpsAgentApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/operations/diagnostic'
    Export:
      Name: !Sub '${AWS::StackName}-DiagnosticUrl'

  ProposeActionEndpointUrl:
    Description: 'Propose action endpoint'
    Value: !Sub 'https://${OpsAgentApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/operations/propose'
    Export:
      Name: !Sub '${AWS::StackName}-ProposeUrl'

  ApproveActionEndpointUrl:
    Description: 'Approve action endpoint'
    Value: !Sub 'https://${OpsAgentApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/operations/approve'
    Export:
      Name: !Sub '${AWS::StackName}-ApproveUrl'

  WorkflowEndpointUrl:
    Description: 'Workflow operations endpoint'
    Value: !Sub 'https://${OpsAgentApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/operations/workflow'
    Export:
      Name: !Sub '${AWS::StackName}-WorkflowUrl'

  PluginApiKey:
    Description: 'API Key for Amazon Q Business Plugin (retrieve from SSM)'
    Value: !Ref OpsAgentApiKeyParameter
    Export:
      Name: !Sub '${AWS::StackName}-PluginApiKeyParam'

  IncidentTableName:
    Description: 'DynamoDB table for incident records'
    Value: !Ref IncidentTable
    Export:
      Name: !Sub '${AWS::StackName}-IncidentTable'

  NotificationTopicArn:
    Description: 'SNS topic for notifications'
    Value: !Ref NotificationTopic
    Export:
      Name: !Sub '${AWS::StackName}-NotificationTopic'

  ApiGatewayUrl:
    Description: 'API Gateway endpoint URL'
    Value: !Sub 'https://${OpsAgentApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}'
    Export:
      Name: !Sub '${AWS::StackName}-ApiUrl'

  HealthEndpointUrl:
    Description: 'Health check endpoint'
    Value: !Sub 'https://${OpsAgentApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/health'
    Export:
      Name: !Sub '${AWS::StackName}-HealthUrl'

  ChatEndpointUrl:
    Description: 'Chat endpoint for sending messages'
    Value: !Sub 'https://${OpsAgentApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/chat'
    Export:
      Name: !Sub '${AWS::StackName}-ChatUrl'

  LambdaFunctionArn:
    Description: 'Lambda function ARN'
    Value: !GetAtt OpsAgentFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-LambdaArn'

  LambdaFunctionName:
    Description: 'Lambda function name'
    Value: !Ref OpsAgentFunction
    Export:
      Name: !Sub '${AWS::StackName}-LambdaName'

  AuditLogGroupName:
    Description: 'CloudWatch Log Group for audit logs'
    Value: !Ref AuditLogGroup
    Export:
      Name: !Sub '${AWS::StackName}-AuditLogGroup'

  AuditTableName:
    Description: 'DynamoDB table for audit storage'
    Value: !Ref AuditTable
    Export:
      Name: !Sub '${AWS::StackName}-AuditTable'

  KMSKeyId:
    Description: 'KMS Key ID for encryption'
    Value: !Ref OpsAgentKMSKey
    Export:
      Name: !Sub '${AWS::StackName}-KMSKey'

  KMSKeyAlias:
    Description: 'KMS Key Alias'
    Value: !Ref OpsAgentKMSKeyAlias
    Export:
      Name: !Sub '${AWS::StackName}-KMSKeyAlias'

  ExecutionRoleArn:
    Description: 'Lambda execution role ARN'
    Value: !GetAtt OpsAgentExecutionRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ExecutionRole'

  ApiKeyParameterName:
    Description: 'SSM Parameter name for API key'
    Value: !Ref ApiKeyParameter
    Export:
      Name: !Sub '${AWS::StackName}-ApiKeyParameter'

  TestInstanceId:
    Condition: CreateTestResources
    Description: 'Test EC2 instance ID for remediation testing'
    Value: !Ref TestInstance
    Export:
      Name: !Sub '${AWS::StackName}-TestInstance'

  DeploymentInstructions:
    Description: 'Next steps after deployment'
    Value: !Sub |
      ## OpsAgent Controller Deployment Complete
      
      ### 1. API Configuration
      - Update API key: aws ssm put-parameter --name "${ApiKeyParameterName}" --value "your-secure-api-key" --type SecureString --overwrite
      - Plugin API Key: aws ssm get-parameter --name "${OpsAgentApiKeyParameter}" --with-decryption --query 'Parameter.Value' --output text
      
      ### 2. Amazon Q Business Plugin Setup
      - Plugin API Endpoint: https://${OpsAgentApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}
      - OpenAPI Schema: Use infrastructure/openapi-schema.yaml
      - API Key: Retrieve from SSM parameter ${OpsAgentApiKeyParameter}
      
      ### 3. Test Endpoints
      - Health: curl https://${OpsAgentApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/health
      - Diagnostic: curl -X POST -H "Content-Type: application/json" -H "X-API-Key: YOUR_KEY" -d '{"operation":"get_ec2_status","parameters":{"instance_id":"i-123"},"user_context":{"user_id":"test@company.com"}}' https://${OpsAgentApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/operations/diagnostic
      
      ### 4. Configuration
      - Execution mode: ${ExecutionMode}
      - Environment: ${Environment}
      - Amazon Q Integration: ${AmazonQAppId}
      
      ### 5. Resources Created
      - Audit Table: ${AuditTable}
      - Incident Table: ${IncidentTable}
      - Notification Topic: ${NotificationTopic}
      - KMS Key: ${OpsAgentKMSKey}

  AmazonQConfiguration:
    Condition: HasAmazonQIntegration
    Description: 'Amazon Q Business integration configuration'
    Value: !Sub |
      Amazon Q Business Application ID: ${AmazonQAppId}
      Amazon Q Business User ID: ${AmazonQUserId}
      Amazon Q Business Session ID: ${AmazonQSessionId}
      Hybrid Mode: Enabled (Amazon Q Business + Bedrock fallback)
      Intent Routing: Operational tasks → OpsAgent, Knowledge queries → Amazon Q Business